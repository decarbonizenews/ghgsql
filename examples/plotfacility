#!/usr/bin/python3
# SPDX-License-Identifier: 0BSD

import argparse
import json
import os
import pathlib
import sys

import MySQLdb
import MySQLdb.cursors
import pandas
import plotly.express

ap = argparse.ArgumentParser()
ap.add_argument("facilityids", nargs="+")
ap.add_argument("-t", "--type", help="Type of emission (Default: CO2)")
args = ap.parse_args()

ppath = os.path.abspath(os.path.join(os.path.dirname(__file__), "../pollutantshort.json"))
pshort = json.loads(pathlib.Path(ppath).read_text())

shorttype = None
if not args.type:
    ptype = "Carbon dioxide (CO2)"
    shorttype = "CO2"
else:
    for k, v in pshort.items():
        if v.lower() == args.type.lower():
            shorttype = v
            ptype = k

if not shorttype:
    ptype = args.type
    shorttype = args.type

c = MySQLdb.connect(cursorclass=MySQLdb.cursors.DictCursor, host="127.0.0.1",
                    database="ghg", user="ghg", password="ghg").cursor()  # noqa: S106

dat = {}
for facilityid in args.facilityids:
    c.execute("SELECT reportingYear,Releases,facilityName FROM eu "
              "WHERE Pollutant=%s AND FacilityInspireId=%s"
              "ORDER BY reportingYear",
              (ptype, facilityid))

    company = {}
    cdata = c.fetchall()
    if not cdata:
        sys.exit(f"No data for {facilityid}")
    d = {}  # pylint workaround...
    for d in cdata:
        year = int(d["reportingYear"])
        company[year] = d["Releases"]
    # FIXME prevent name collissions
    dat[d["facilityName"]] = company
dat = pandas.DataFrame(dat).sort_index()

fig = plotly.express.line(dat, markers=True)
fig.update_layout(yaxis_title=f"kg{shorttype}", xaxis_title="year")
fig.update_yaxes(rangemode="tozero")
fig.update_traces(connectgaps=True)
fig.show()
